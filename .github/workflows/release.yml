name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for the build (e.g., v1.0.0)'
        required: false
        default: ''

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-type: [unit, e2e-node, e2e-bun]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Node.js
      if: matrix.test-type == 'e2e-node'
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: bun install

    - name: Run unit tests
      if: matrix.test-type == 'unit'
      run: bun test test/

    - name: Run E2E tests with Node.js
      if: matrix.test-type == 'e2e-node'
      run: |
        export BUNOSH_RUNTIME=node
        npx vitest run

    - name: Run E2E tests with Bun
      if: matrix.test-type == 'e2e-bun'
      run: |
        export BUNOSH_RUNTIME=bun
        bun run test:e2e

  build-binaries:
    name: Build Binaries
    runs-on: ${{ matrix.os }}
    needs: test
    
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: bun-linux-x64
            artifact: bunosh-linux-x64
            archive: tar.gz
          - os: macos-latest
            target: bun-darwin-arm64
            artifact: bunosh-darwin-arm64
            archive: tar.gz
          - os: windows-latest
            target: bun-windows-x64
            artifact: bunosh-windows-x64.exe
            archive: zip

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
        elif [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
          VERSION=${VERSION#v}
        else
          VERSION=$(node -p "require('./package.json').version")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
      shell: bash


    - name: Build binary
      run: |
        mkdir -p dist
        bun build ./bunosh.js --compile --define BUNOSH_EXECUTABLE=true --target=${{ matrix.target }} --outfile dist/${{ matrix.artifact }}
      shell: bash

    - name: Make executable (Unix)
      if: runner.os != 'Windows'
      run: chmod +x dist/${{ matrix.artifact }}

    - name: Test binary
      run: |
        cd dist
        if [ "${{ runner.os }}" = "Windows" ]; then
          ./${{ matrix.artifact }} --version || echo "Version check completed"
          ./${{ matrix.artifact }} --help || echo "Help check completed"
        else
          ./${{ matrix.artifact }} --version || echo "Version check completed"
          ./${{ matrix.artifact }} --help || echo "Help check completed"
        fi
      shell: bash

    - name: Create archive (Unix)
      if: runner.os != 'Windows'
      run: |
        cd dist
        tar -czf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}

    - name: Create archive (Windows)  
      if: runner.os == 'Windows'
      run: |
        cd dist
        Compress-Archive -Path ${{ matrix.artifact }} -DestinationPath ${{ matrix.artifact }}.zip
      shell: powershell

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          dist/${{ matrix.artifact }}.${{ matrix.archive }}
        retention-days: 30

  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [test, build-binaries]
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: Setup Node.js for NPM
      uses: actions/setup-node@v4
      with:
        node-version: 20
        registry-url: 'https://registry.npmjs.org'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
        elif [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
          VERSION=${VERSION#v}
        else
          VERSION=$(node -p "require('./package.json').version")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "NPM version: $VERSION"
      shell: bash

    - name: Verify package.json version
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current package.json version: $CURRENT_VERSION"
        echo "Expected version: ${{ steps.version.outputs.version }}"
        
        if [ "$CURRENT_VERSION" != "${{ steps.version.outputs.version }}" ]; then
          echo "Updating package.json version to match release version"
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version --allow-same-version
        fi

    - name: Run final tests
      run: |
        echo "Running tests before NPM publish..."
        bun test test/

    - name: Publish to NPM
      run: |
        # Determine npm tag
        if [[ "${{ steps.version.outputs.version }}" == *"beta"* ]] || [[ "${{ steps.version.outputs.version }}" == *"alpha"* ]] || [[ "${{ steps.version.outputs.version }}" == *"rc"* ]]; then
          NPM_TAG="beta"
        else
          NPM_TAG="latest"
        fi
        
        echo "ðŸ“¦ Publishing to NPM..."
        echo "   Version: ${{ steps.version.outputs.version }}"
        echo "   Tag: $NPM_TAG"
        echo "   Registry: $(npm config get registry)"
        
        # Verify package.json
        echo "   Package name: $(node -p "require('./package.json').name")"
        echo "   Package version: $(node -p "require('./package.json').version")"
        
        # Publish with detailed output
        npm publish --tag $NPM_TAG --access public
        
        echo "âœ… Successfully published to NPM!"
        echo "   Install with: npm install -g bunosh@$NPM_TAG"
        
        # Create job summary
        echo "## ðŸ“¦ NPM Publication Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**NPM Tag**: $NPM_TAG" >> $GITHUB_STEP_SUMMARY
        echo "**Install Command**: \`npm install -g bunosh@$NPM_TAG\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Published successfully to NPM registry**" >> $GITHUB_STEP_SUMMARY
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Commit package.json version update
      if: github.event_name == 'release'
      run: |
        # Configure git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Ensure we're on main branch
        git fetch origin main
        git checkout main
        git pull origin main
        
        # Update package.json version
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        if [ "$CURRENT_VERSION" != "${{ steps.version.outputs.version }}" ]; then
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version --allow-same-version
          git add package.json
          git commit -m "chore: Update version to ${{ steps.version.outputs.version }} [skip ci]"
          git push origin main
        fi

  release:
    name: Attach Release Assets
    runs-on: ubuntu-latest
    needs: build-binaries
    if: github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-assets

    - name: List artifacts
      run: |
        echo "Release artifacts:"
        find release-assets -type f -name "*.tar.gz" -o -name "*.zip" | sort

    - name: Attach binaries to release
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          release-assets/bunosh-linux-x64/bunosh-linux-x64.tar.gz
          release-assets/bunosh-darwin-arm64/bunosh-darwin-arm64.tar.gz
          release-assets/bunosh-windows-x64.exe/bunosh-windows-x64.exe.zip
        body: |
          ## ðŸš€ Bunosh Release ${{ github.ref_name }}

          ### Single Executables (No Runtime Required)
          
          - **Linux x64**: `bunosh-linux-x64.tar.gz`
          - **macOS ARM64**: `bunosh-darwin-arm64.tar.gz` 
          - **Windows x64**: `bunosh-windows-x64.exe.zip`

          ### Installation

          **Single Executable:**
          ```bash
          # Linux
          curl -fsSL https://github.com/davertmik/bunosh/releases/latest/download/bunosh-linux-x64.tar.gz | tar -xz
          sudo mv bunosh-linux-x64 /usr/local/bin/bunosh

          # macOS
          curl -fsSL https://github.com/davertmik/bunosh/releases/latest/download/bunosh-darwin-arm64.tar.gz | tar -xz  
          sudo mv bunosh-darwin-arm64 /usr/local/bin/bunosh

          # Windows (PowerShell)
          Invoke-WebRequest -Uri "https://github.com/davertmik/bunosh/releases/latest/download/bunosh-windows-x64.exe.zip" -OutFile "bunosh.zip"
          Expand-Archive -Path "bunosh.zip" -DestinationPath .
          Move-Item "bunosh-windows-x64.exe" "bunosh.exe"
          ```

          **NPM Package:**
          ```bash
          npm install -g bunosh
          # or
          bun add -g bunosh
          ```

          ### Upgrade
          
          **Single Executable:**
          ```bash
          bunosh upgrade
          ```
          
          **NPM Package:**
          ```bash
          npm update -g bunosh
          ```

          ### What's New
          - âœ… Shell auto-completion with `bunosh setup-completion`
          - âœ… Self-upgrade with `bunosh upgrade` (single executables only)
          - âœ… Enhanced cross-platform compatibility
          - âœ… Improved error handling and user experience

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [test, build-binaries, publish-npm, release]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "## ðŸš€ Release Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
        echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Test results
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… **Tests**: All test suites passed (unit, e2e-node, e2e-bun)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Tests**: Some test suites failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Build results  
        if [ "${{ needs.build-binaries.result }}" == "success" ]; then
          echo "âœ… **Build Binaries**: All platform binaries built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Build Binaries**: Failed to build some platform binaries" >> $GITHUB_STEP_SUMMARY
        fi
        
        # NPM publish results
        if [ "${{ needs.publish-npm.result }}" == "success" ]; then
          echo "âœ… **NPM Publish**: Successfully published to NPM registry" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.publish-npm.result }}" == "skipped" ]; then
          echo "â„¹ï¸ **NPM Publish**: Skipped (not a release or manual trigger)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **NPM Publish**: Failed to publish to NPM" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Release results
        if [ "${{ needs.release.result }}" == "success" ]; then
          echo "âœ… **Release**: Assets attached to GitHub release" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.event_name }}" != "release" ]; then
          echo "â„¹ï¸ **Release**: Skipped (not a release trigger)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Release**: Failed to attach release assets" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Deliverables" >> $GITHUB_STEP_SUMMARY
        echo "- **NPM**: \`npm install -g bunosh\`" >> $GITHUB_STEP_SUMMARY  
        echo "- **Bun**: \`bun add -g bunosh\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Linux x64**: Single executable with Bun runtime" >> $GITHUB_STEP_SUMMARY
        echo "- **macOS ARM64**: Single executable with Bun runtime" >> $GITHUB_STEP_SUMMARY
        echo "- **Windows x64**: Single executable with Bun runtime" >> $GITHUB_STEP_SUMMARY